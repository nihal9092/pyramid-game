<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pyramid - Social Hierarchy Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        
        :root {
            --gold: #d4af37;
            --dark: #0a0a0a;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--dark);
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .cinzel {
            font-family: 'Cinzel', serif;
        }

        /* Background Animation */
        .bg-animate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            z-index: -1;
        }

        /* Gold Glow Effect */
        .gold-glow {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.15);
            transition: var(--transition);
        }

        .gold-glow:hover {
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.12);
        }

        /* Fade In Animation */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User Card Hover */
        .user-card {
            transition: var(--transition);
        }

        .user-card:hover {
            background: rgba(212, 175, 55, 0.04);
            transform: scale(1.01);
        }

        /* Bounty Effect */
        .bounty-target {
            border: 2px solid #ff4444 !important;
            background: linear-gradient(45deg, #2a0000, #0a0a0a) !important;
            animation: bountyPulse 1.5s infinite alternate;
        }

        @keyframes bountyPulse {
            from {
                box-shadow: 0 0 5px #ff0000;
            }
            to {
                box-shadow: 0 0 20px #ff0000;
            }
        }

        /* Welcome Overlay */
        #welcome-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9));
            backdrop-filter: blur(8px);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        #welcome-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Pyramid Animation */
        .pyramid-anim {
            width: 260px;
            height: 220px;
            margin: 0 auto;
        }

        .pyramid-anim .layer {
            transform-origin: center bottom;
            animation: pop 0.6s ease forwards;
            opacity: 0;
        }

        .pyramid-anim .layer.l1 { animation-delay: 0.05s; }
        .pyramid-anim .layer.l2 { animation-delay: 0.15s; }
        .pyramid-anim .layer.l3 { animation-delay: 0.25s; }
        .pyramid-anim .layer.l4 { animation-delay: 0.35s; }
        .pyramid-anim .layer.l5 { animation-delay: 0.45s; }

        @keyframes pop {
            from {
                transform: translateY(-20px) scale(0.6);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(90deg, #d4af37, #f0c85a);
            color: #0b0b0b;
            font-weight: bold;
            transition: var(--transition);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            border: 1px solid #d4af37;
            color: #d4af37;
            transition: var(--transition);
        }

        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        /* Input Focus */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--gold) !important;
        }

        /* Chat Message */
        .chat-message {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }

        .chat-message.own {
            background: rgba(212, 175, 55, 0.1);
            margin-left: auto;
            max-width: 80%;
        }

        .chat-message.other {
            background: rgba(255, 255, 255, 0.05);
            margin-right: auto;
            max-width: 80%;
        }

        /* Admin FAB */
        .admin-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3.5rem;
            height: 3.5rem;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            transition: var(--transition);
        }

        .admin-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.7);
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-top-color: var(--gold);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pyramid-anim {
                width: 200px;
                height: 170px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animate"></div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-6 fade-in">
        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Registration Panel -->
            <div class="p-8 border border-zinc-800 rounded-lg gold-glow bg-black/60">
                <h1 class="cinzel text-4xl text-[#d4af37] tracking-[0.2em] mb-2">PYRAMID</h1>
                <p class="text-[11px] tracking-[0.4em] text-zinc-500 mb-6 uppercase">Social Hierarchy Protocol</p>

                <div class="space-y-4">
                    <input 
                        id="auth-name" 
                        type="text" 
                        placeholder="Full Real Name" 
                        class="w-full bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                        autocomplete="name"
                    />
                    
                    <div class="flex gap-2">
                        <select 
                            id="auth-gender" 
                            class="flex-1 bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                        >
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        
                        <input 
                            id="auth-roll" 
                            type="text" 
                            placeholder="Roll Number" 
                            class="w-1/2 bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                        />
                    </div>
                    
                    <div class="flex gap-2">
                        <input 
                            id="auth-class" 
                            type="text" 
                            placeholder="Class (e.g. 11)" 
                            class="flex-1 bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                        />
                        
                        <input 
                            id="auth-sec" 
                            type="text" 
                            placeholder="Section (e.g. A)" 
                            class="w-1/4 bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                            maxlength="1"
                        />
                    </div>
                    
                    <input 
                        id="auth-email" 
                        type="email" 
                        placeholder="Email (optional)" 
                        class="w-full bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                        autocomplete="email"
                    />
                    
                    <div class="relative">
                        <input 
                            id="auth-pass" 
                            type="password" 
                            placeholder="Create a password (min 8 characters)" 
                            class="w-full bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md pr-16"
                            autocomplete="new-password"
                            minlength="8"
                        />
                        <button 
                            id="toggle-pass" 
                            type="button"
                            class="absolute right-3 top-3 text-xs text-zinc-400 hover:text-zinc-200"
                        >
                            Show
                        </button>
                    </div>

                    <button 
                        id="register-btn" 
                        class="w-full py-3 cinzel btn-primary rounded-md"
                    >
                        Register & Enter
                    </button>

                    <p class="text-red-400 text-xs font-medium mt-2">
                        âš  Please use your real name and school roll number. Duplicates are not allowed.
                    </p>
                </div>
            </div>

            <!-- Login Panel -->
            <div class="p-8 border border-zinc-800 rounded-lg gold-glow bg-black/50 flex flex-col justify-between">
                <div>
                    <h3 class="cinzel text-xl text-white mb-4">Secure Access</h3>
                    
                    <div class="space-y-4">
                        <input 
                            id="login-name" 
                            type="text" 
                            placeholder="Full Name" 
                            class="w-full bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                            autocomplete="username"
                        />
                        
                        <input 
                            id="login-pass" 
                            type="password" 
                            placeholder="Password" 
                            class="w-full bg-zinc-900/40 border border-zinc-800 p-3 text-sm rounded-md"
                            autocomplete="current-password"
                        />
                        
                        <button 
                            id="login-btn"
                            class="w-full py-3 cinzel btn-primary rounded-md"
                        >
                            Login
                        </button>
                    </div>
                </div>
                
                <p class="text-[10px] text-zinc-500 mt-6">
                    By registering you agree to the community rules. Misuse may result in termination.
                </p>
            </div>
        </div>
    </div>

    <!-- Welcome Overlay -->
    <div id="welcome-overlay">
        <div class="max-w-lg text-center p-8 rounded-lg gold-glow bg-black/60">
            <div class="pyramid-anim" aria-hidden="true">
                <svg viewBox="0 0 200 150" class="mx-auto block">
                    <polygon class="layer l5" points="100,10 140,70 60,70" fill="#d4af37" opacity="0.95" />
                    <polygon class="layer l4" points="100,35 150,95 50,95" fill="#c59d2e" opacity="0.9" />
                    <polygon class="layer l3" points="100,60 160,120 40,120" fill="#a67c1a" opacity="0.85" />
                    <polygon class="layer l2" points="100,85 170,145 30,145" fill="#8a5f10" opacity="0.8" />
                    <polygon class="layer l1" points="100,105 180,170 20,170" fill="#6b4808" opacity="0.8" />
                </svg>
            </div>
            
            <h2 id="welcome-title" class="cinzel text-3xl text-[#d4af37] mt-4">Welcome</h2>
            <p id="welcome-sub" class="text-sm text-zinc-400 mt-2">Initializing the hierarchy...</p>
            
            <button 
                id="welcome-proceed"
                class="mt-6 py-3 px-8 rounded-md bg-[#d4af37] text-black font-bold cinzel hover:shadow-lg transition-all"
            >
                Proceed
            </button>
        </div>
    </div>

    <!-- Application Screen -->
    <div id="app-screen" class="hidden max-w-4xl mx-auto px-6 py-10 fade-in">
        <!-- Header -->
        <header class="flex justify-between items-end mb-12 border-b border-zinc-800 pb-6">
            <div>
                <p class="text-[10px] text-zinc-500 tracking-widest uppercase mb-1">Current Subject</p>
                <h2 id="my-name-display" class="cinzel text-2xl text-white">---</h2>
                <p id="my-title-display" class="text-[10px] text-[#d4af37] font-bold tracking-widest uppercase">Commoner</p>
            </div>
            
            <div class="text-right">
                <p class="text-[10px] text-zinc-500 tracking-widest uppercase mb-1">Credits</p>
                <h2 id="my-credits-display" class="text-xl font-mono text-white">0</h2>
            </div>
        </header>

        <!-- Pyramid List -->
        <div id="pyramid-list" class="space-y-4 mb-16"></div>

        <!-- Chat Section -->
        <div class="bg-[#0a0a0a] border border-zinc-900 rounded-lg overflow-hidden gold-glow">
            <div class="p-4 border-b border-zinc-900 bg-zinc-900/20 flex justify-between items-center">
                <h3 class="cinzel text-xs tracking-[0.4em] text-[#d4af37]">Grand Hall Chat</h3>
                <div id="typing-indicator" class="text-[9px] text-zinc-600 italic hidden">Someone is typing...</div>
            </div>
            
            <div id="chat-box" class="h-80 overflow-y-auto p-4 flex flex-col bg-black"></div>
            
            <div class="p-4 bg-black/50 border-t border-zinc-900 flex gap-2">
                <input 
                    id="chat-input" 
                    type="text"
                    placeholder="Whisper to the hierarchy..." 
                    class="flex-1 bg-transparent border border-zinc-800 p-3 text-xs text-white rounded-md"
                    maxlength="500"
                />
                <button 
                    id="send-chat"
                    class="bg-[#d4af37] text-black px-6 text-[10px] font-bold cinzel rounded-md hover:opacity-90"
                >
                    SEND
                </button>
            </div>
        </div>

        <!-- Logout -->
        <button 
            id="logout-btn"
            class="mt-10 text-[10px] text-zinc-600 uppercase tracking-widest hover:text-red-500 transition-all"
        >
            Terminate Session
        </button>
    </div>

    <!-- Admin FAB (Hidden by default) -->
    <div id="admin-fab" class="admin-fab hidden">
        <span class="cinzel text-black text-2xl font-bold">N</span>
    </div>

    <!-- Main Application Script -->
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // NOTE: In production, use environment variables and Firebase Security Rules
        // Never expose sensitive credentials in client-side code
        const firebaseConfig = {
            apiKey: "AIzaSyBs81OlYrQ1_HBUHJ3Tim1vT-2glHOZPbc",
            authDomain: "pyramidgame2026.firebaseapp.com",
            projectId: "pyramidgame2026",
            storageBucket: "pyramidgame2026.firebasestorage.app",
            messagingSenderId: "302574478188",
            appId: "1:302574478188:web:aded8d66bdd1f828da8949"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        let currentUser = null;
        let chatUnsubscribe = null;
        let usersUnsubscribe = null;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        /**
         * Sanitize user input to prevent XSS attacks
         */
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        /**
         * Hash password using SHA-256
         */
        async function hashPassword(password) {
            if (!password) return '';
            
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error('Password hashing error:', error);
                throw new Error('Failed to secure password');
            }
        }

        /**
         * Validate email format
         */
        function isValidEmail(email) {
            if (!email) return true; // Email is optional
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        /**
         * Show error message
         */
        function showError(message) {
            alert(message); // In production, use a toast notification system
        }

        /**
         * Show success message
         */
        function showSuccess(message) {
            alert(message); // In production, use a toast notification system
        }

        /**
         * Toggle password visibility
         */
        function setupPasswordToggle() {
            const toggleBtn = document.getElementById('toggle-pass');
            const passwordInput = document.getElementById('auth-pass');
            
            if (toggleBtn && passwordInput) {
                toggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        toggleBtn.textContent = 'Hide';
                    } else {
                        passwordInput.type = 'password';
                        toggleBtn.textContent = 'Show';
                    }
                });
            }
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        
        /**
         * Handle user registration
         */
        async function handleRegister() {
            try {
                // Get form values
                const name = document.getElementById('auth-name').value.trim();
                const gender = document.getElementById('auth-gender').value;
                const roll = document.getElementById('auth-roll').value.trim();
                const cls = document.getElementById('auth-class').value.trim();
                const sec = document.getElementById('auth-sec').value.trim().toUpperCase();
                const email = document.getElementById('auth-email').value.trim();
                const password = document.getElementById('auth-pass').value;

                // Validation
                if (!name || !gender || !roll || !cls || !sec || !password) {
                    showError('Please complete all required fields.');
                    return;
                }

                if (password.length < 8) {
                    showError('Password must be at least 8 characters long.');
                    return;
                }

                if (email && !isValidEmail(email)) {
                    showError('Please enter a valid email address.');
                    return;
                }

                // Check if user already exists
                const userRef = db.collection('users').doc(name);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    showError('A user with this name already exists. Please login or use a different name.');
                    return;
                }

                // Check if roll number is already used
                const rollQuery = await db.collection('users')
                    .where('rollNumber', '==', roll)
                    .get();
                
                if (!rollQuery.empty) {
                    showError('This roll number has already been registered.');
                    return;
                }

                // Hash password
                const passwordHash = await hashPassword(password);

                // Create user document
                await userRef.set({
                    name: sanitizeInput(name),
                    gender: gender,
                    rollNumber: roll,
                    class: cls,
                    section: sec,
                    email: email ? sanitizeInput(email) : '',
                    passwordHash: passwordHash,
                    credits: 100000,
                    title: 'Commoner',
                    totalVotesReceived: 0,
                    votesRemaining: 3,
                    registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Save to localStorage
                localStorage.setItem('pyramidUser', name);
                currentUser = name;

                // Show welcome and enter app
                showWelcome(name, 'Welcome to the Pyramid â€” your hierarchy awaits');
                await enterApp();

            } catch (error) {
                console.error('Registration error:', error);
                showError('Registration failed. Please try again.');
            }
        }

        /**
         * Handle user login
         */
        async function handleLogin() {
            try {
                const name = document.getElementById('login-name').value.trim();
                const password = document.getElementById('login-pass').value;

                if (!name || !password) {
                    showError('Please enter your name and password.');
                    return;
                }

                // Get user document
                const userRef = db.collection('users').doc(name);
                const userDoc = await userRef.get();

                if (!userDoc.exists) {
                    showError('User not found. Please check your name or register.');
                    return;
                }

                // Verify password
                const passwordHash = await hashPassword(password);
                const userData = userDoc.data();

                if (passwordHash !== userData.passwordHash) {
                    showError('Incorrect password.');
                    return;
                }

                // Update last active
                await userRef.update({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Save to localStorage
                localStorage.setItem('pyramidUser', name);
                currentUser = name;

                // Show welcome and enter app
                showWelcome(name, 'Welcome back â€” may your status rise');
                await enterApp();

            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
            }
        }

        /**
         * Handle logout
         */
        async function handleLogout() {
            try {
                // Cleanup listeners
                if (chatUnsubscribe) chatUnsubscribe();
                if (usersUnsubscribe) usersUnsubscribe();

                // Clear localStorage
                localStorage.removeItem('pyramidUser');
                currentUser = null;

                // Reload page
                window.location.reload();

            } catch (error) {
                console.error('Logout error:', error);
                showError('Logout failed. Please refresh the page.');
            }
        }

        // ============================================
        // WELCOME OVERLAY
        // ============================================
        
        /**
         * Show welcome overlay
         */
        function showWelcome(name, subtitle) {
            const overlay = document.getElementById('welcome-overlay');
            const title = document.getElementById('welcome-title');
            const sub = document.getElementById('welcome-sub');

            title.textContent = `Greetings, ${sanitizeInput(name)}`;
            sub.textContent = subtitle;
            
            overlay.classList.add('show');
        }

        /**
         * Close welcome overlay
         */
        function closeWelcome() {
            const overlay = document.getElementById('welcome-overlay');
            overlay.classList.remove('show');
        }

        // ============================================
        // APP INITIALIZATION
        // ============================================
        
        /**
         * Enter the main application
         */
        async function enterApp() {
            try {
                // Hide auth screen, show app screen
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');

                // Load user data
                const userRef = db.collection('users').doc(currentUser);
                const userDoc = await userRef.get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Update header
                    document.getElementById('my-name-display').textContent = currentUser;
                    document.getElementById('my-credits-display').textContent = userData.credits.toLocaleString();
                    document.getElementById('my-title-display').textContent = userData.title;

                    // Show admin FAB for authorized user
                    if (currentUser === 'Nihal Gupta') {
                        document.getElementById('admin-fab').classList.remove('hidden');
                    }
                }

                // Load hierarchy
                loadHierarchy();

                // Initialize chat
                initializeChat();

            } catch (error) {
                console.error('App initialization error:', error);
                showError('Failed to load application. Please try again.');
            }
        }

        // ============================================
        // HIERARCHY MANAGEMENT
        // ============================================
        
        /**
         * Load and display the hierarchy
         */
        function loadHierarchy() {
            const listContainer = document.getElementById('pyramid-list');

            // Listen for real-time updates
            usersUnsubscribe = db.collection('users')
                .orderBy('totalVotesReceived', 'desc')
                .onSnapshot((snapshot) => {
                    listContainer.innerHTML = '';
                    let rank = 1;

                    snapshot.forEach((doc) => {
                        const userData = doc.data();
                        const isCurrentUser = userData.name === currentUser;
                        const isTopRank = rank === 1;
                        const hasBounty = userData.isBounty || false;

                        // Create user card
                        const card = document.createElement('div');
                        card.className = `user-card p-5 border rounded-lg flex justify-between items-center ${
                            hasBounty 
                                ? 'bounty-target' 
                                : isTopRank 
                                    ? 'border-[#d4af37] bg-[#d4af37]/5' 
                                    : 'border-zinc-900 bg-zinc-900/30'
                        }`;

                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <span class="cinzel text-xl ${isTopRank ? 'text-[#d4af37]' : 'text-zinc-700'}">
                                    #${rank}
                                </span>
                                <div>
                                    <p class="font-bold ${isCurrentUser ? 'text-[#d4af37]' : 'text-white'}">
                                        ${sanitizeInput(userData.name)}
                                    </p>
                                    <p class="text-[9px] tracking-widest uppercase text-zinc-500">
                                        ${isTopRank ? 'ðŸ‘‘ Popularity King' : userData.title}
                                    </p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button 
                                    onclick="handleVote('${userData.name}')" 
                                    class="text-[9px] tracking-widest border border-zinc-700 px-4 py-2 rounded hover:border-[#d4af37] transition-all"
                                    ${isCurrentUser ? 'disabled' : ''}
                                >
                                    VOTE
                                </button>
                            </div>
                        `;

                        listContainer.appendChild(card);
                        rank++;
                    });
                }, (error) => {
                    console.error('Hierarchy load error:', error);
                });
        }

        /**
         * Handle voting for a user
         */
        async function handleVote(targetName) {
            try {
                if (targetName === currentUser) {
                    showError('You cannot vote for yourself.');
                    return;
                }

                // Check if user has votes remaining
                const currentUserRef = db.collection('users').doc(currentUser);
                const currentUserDoc = await currentUserRef.get();
                
                if (!currentUserDoc.exists) {
                    showError('User session expired. Please login again.');
                    return;
                }

                const votesRemaining = currentUserDoc.data().votesRemaining || 0;
                
                if (votesRemaining <= 0) {
                    showError('You have no votes remaining today.');
                    return;
                }

                // Update target user's votes
                const targetUserRef = db.collection('users').doc(targetName);
                await targetUserRef.update({
                    totalVotesReceived: firebase.firestore.FieldValue.increment(1)
                });

                // Decrease voter's remaining votes
                await currentUserRef.update({
                    votesRemaining: firebase.firestore.FieldValue.increment(-1)
                });

                showSuccess(`Vote recorded for ${targetName}!`);

            } catch (error) {
                console.error('Voting error:', error);
                showError('Failed to record vote. Please try again.');
            }
        }

        // ============================================
        // CHAT SYSTEM
        // ============================================
        
        /**
         * Initialize real-time chat
         */
        function initializeChat() {
            const chatBox = document.getElementById('chat-box');

            // Listen for chat messages
            chatUnsubscribe = db.collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot((snapshot) => {
                    chatBox.innerHTML = '';

                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        const isOwnMessage = message.sender === currentUser;

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${isOwnMessage ? 'own' : 'other'}`;
                        
                        messageDiv.innerHTML = `
                            <div class="text-[10px] text-zinc-400 mb-1">
                                ${sanitizeInput(message.sender)}
                            </div>
                            <div class="text-sm">
                                ${sanitizeInput(message.text)}
                            </div>
                        `;

                        chatBox.appendChild(messageDiv);
                    });

                    // Auto-scroll to bottom
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, (error) => {
                    console.error('Chat load error:', error);
                });
        }

        /**
         * Send a chat message
         */
        async function sendMessage() {
            try {
                const input = document.getElementById('chat-input');
                const messageText = input.value.trim();

                if (!messageText) return;

                if (messageText.length > 500) {
                    showError('Message is too long. Maximum 500 characters.');
                    return;
                }

                // Add message to Firestore
                await db.collection('messages').add({
                    sender: currentUser,
                    text: sanitizeInput(messageText),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Clear input
                input.value = '';

            } catch (error) {
                console.error('Send message error:', error);
                showError('Failed to send message. Please try again.');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Setup password toggle
            setupPasswordToggle();

            // Register button
            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }

            // Login button
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }

            // Logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            // Welcome proceed button
            const proceedBtn = document.getElementById('welcome-proceed');
            if (proceedBtn) {
                proceedBtn.addEventListener('click', closeWelcome);
            }

            // Send chat button
            const sendBtn = document.getElementById('send-chat');
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }

            // Chat input Enter key
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Check for existing session
            const savedUser = localStorage.getItem('pyramidUser');
            if (savedUser) {
                currentUser = savedUser;
                
                // Verify user still exists
                db.collection('users').doc(savedUser).get()
                    .then(doc => {
                        if (doc.exists) {
                            showWelcome(savedUser, 'Welcome back');
                            enterApp();
                        } else {
                            localStorage.removeItem('pyramidUser');
                        }
                    })
                    .catch(error => {
                        console.error('Session verification error:', error);
                        localStorage.removeItem('pyramidUser');
                    });
            }
        });

        // ============================================
        // ADMIN FUNCTIONS (Placeholder)
        // ============================================
        
        /**
         * Open admin panel (implement as needed)
         */
        function openAdminPower() {
            if (currentUser === 'Nihal Gupta') {
                showSuccess('Admin panel access granted');
                // Implement admin functionality here
            }
        }

        // Admin FAB click
        const adminFab = document.getElementById('admin-fab');
        if (adminFab) {
            adminFab.addEventListener('click', openAdminPower);
        }
    </script>
</body>
</html>